import{r,j as e,C as E,B as se,f as te,g as ae,h as ne,p as re,i as le,k as oe}from"./index-Ct1VwyzL.js";import{C as A,a as q,b as O,c as ie,d as L,B as ce}from"./badge-CHKfXRgz.js";import{c as N,b as v,B as y}from"./button-ZNqFvPe-.js";import{X as de,I as ue}from"./input-DsavT3Vm.js";import{a as me,S as P}from"./api-Cw-I1fGx.js";import{M as he}from"./message-circle-DHDhTTby.js";const pe=[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"M18 17V9",key:"2bz60n"}],["path",{d:"M13 17V5",key:"1frdt8"}],["path",{d:"M8 17v-3",key:"17ska0"}]],fe=N("chart-column",pe);const xe=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],ge=N("download",xe);const be=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]],V=N("history",be);const je=[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]],ye=N("message-square",je);const ve=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],Ne=N("trash-2",ve),D=r.forwardRef(({className:t,...a},n)=>e.jsx("div",{className:"relative w-full overflow-auto",children:e.jsx("table",{ref:n,className:v("w-full caption-bottom text-sm",t),...a})}));D.displayName="Table";const U=r.forwardRef(({className:t,...a},n)=>e.jsx("thead",{ref:n,className:v("[&_tr]:border-b",t),...a}));U.displayName="TableHeader";const G=r.forwardRef(({className:t,...a},n)=>e.jsx("tbody",{ref:n,className:v("[&_tr:last-child]:border-0",t),...a}));G.displayName="TableBody";const T=r.forwardRef(({className:t,...a},n)=>e.jsx("tr",{ref:n,className:v("border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",t),...a}));T.displayName="TableRow";const J=r.forwardRef(({className:t,...a},n)=>e.jsx("th",{ref:n,className:v("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",t),...a}));J.displayName="TableHead";const K=r.forwardRef(({className:t,...a},n)=>e.jsx("td",{ref:n,className:v("p-4 align-middle [&:has([role=checkbox])]:pr-0",t),...a}));K.displayName="TableCell";const Q="label";function $(t,a){typeof t=="function"?t(a):t&&(t.current=a)}function we(t,a){const n=t.options;n&&a&&Object.assign(n,a)}function F(t,a){t.labels=a}function W(t,a,n=Q){const u=[];t.datasets=a.map(i=>{const m=t.datasets.find(l=>l[n]===i[n]);return!m||!i.data||u.includes(m)?{...i}:(u.push(m),Object.assign(m,i),m)})}function ke(t,a=Q){const n={labels:[],datasets:[]};return F(n,t.labels),W(n,t.datasets,a),n}function Ce(t,a){const{height:n=150,width:u=300,redraw:i=!1,datasetIdKey:m,type:l,data:h,options:p,plugins:d=[],fallbackContent:f,updateMode:w,...S}=t,x=r.useRef(null),c=r.useRef(null),g=()=>{x.current&&(c.current=new E(x.current,{type:l,data:ke(h,m),options:p&&{...p},plugins:d}),$(a,c.current))},b=()=>{$(a,null),c.current&&(c.current.destroy(),c.current=null)};return r.useEffect(()=>{!i&&c.current&&p&&we(c.current,p)},[i,p]),r.useEffect(()=>{!i&&c.current&&F(c.current.config.data,h.labels)},[i,h.labels]),r.useEffect(()=>{!i&&c.current&&h.datasets&&W(c.current.config.data,h.datasets,m)},[i,h.datasets]),r.useEffect(()=>{c.current&&(i?(b(),setTimeout(g)):c.current.update(w))},[i,p,h.labels,h.datasets,w]),r.useEffect(()=>{c.current&&(b(),setTimeout(g))},[l]),r.useEffect(()=>(g(),()=>b()),[]),e.jsx("canvas",{ref:x,role:"img",height:n,width:u,...S,children:f})}const Re=r.forwardRef(Ce);function Se(t,a){return E.register(a),r.forwardRef((n,u)=>e.jsx(Re,{...n,ref:u,type:t}))}const _e=Se("bar",se);E.register(te,ae,ne,re,le,oe);const I="gainwell_genie_chat";function M(){try{const t=sessionStorage.getItem(I);if(!t)return{messages:[],conversationId:null,lastResponse:null};const a=JSON.parse(t);return{messages:a.messages??[],conversationId:a.conversationId??null,lastResponse:a.lastResponse??null}}catch{return{messages:[],conversationId:null,lastResponse:null}}}function Me(t,a,n){try{sessionStorage.setItem(I,JSON.stringify({messages:t,conversationId:a,lastResponse:n}))}catch{}}function qe(){const[t,a]=r.useState(""),[n,u]=r.useState(()=>M().messages),[i,m]=r.useState(()=>M().conversationId),[l,h]=r.useState(()=>M().lastResponse),p=r.useRef(null);r.useEffect(()=>{Me(n,i,l)},[n,i,l]),r.useEffect(()=>{p.current?.scrollIntoView({behavior:"smooth"})},[n]);const d=me(),f=r.useCallback(s=>{u(o=>[...o,{role:"assistant",text:s.text_response??s.error??"No response.",meta:s.row_count!=null?`${s.row_count} rows`:void 0}]),s.conversation_id&&m(s.conversation_id),h(s)},[]),w=r.useCallback(s=>{s.preventDefault();const o=t.trim();!o||d.isPending||(u(j=>[...j,{role:"user",text:o}]),a(""),d.mutate({question:o,conversation_id:i},{onSuccess:f}))},[t,i,d,f]),S=r.useCallback(()=>{u([]),m(null),h(null),b(!1);try{sessionStorage.removeItem(I)}catch{}},[]),x=n.map((s,o)=>s.role==="user"?{index:o,text:s.text}:null).filter(Boolean),c=r.useCallback(()=>{if(!l?.columns?.length||!l?.data?.length)return;const s=l.columns,o=l.data.map(Z=>s.map((Te,ee)=>{const B=Z[ee],R=B==null?"":String(B);return R.includes(",")||R.includes('"')?`"${R.replace(/"/g,'""')}"`:R}).join(",")),j=[s.join(","),...o].join(`
`),_=new Blob([j],{type:"text/csv"}),C=document.createElement("a");C.href=URL.createObjectURL(_),C.download="genie_result.csv",C.click(),URL.revokeObjectURL(C.href)},[l]),[g,b]=r.useState(!1),[H,k]=r.useState(!1),X=r.useCallback(s=>{!s.trim()||d.isPending||(u(o=>[...o,{role:"user",text:s}]),k(!1),d.mutate({question:s.trim(),conversation_id:i},{onSuccess:f}))},[i,d,f]),z=l?.columns?.length&&l?.data?.length&&l.data.length>0?{labels:l.data.map(s=>String(s[0]??"")),datasets:[{label:l.columns[1]??"Value",data:l.data.map(s=>{const o=s[1];return typeof o=="number"?o:Number(o)||0}),backgroundColor:"rgba(59, 130, 246, 0.85)",borderColor:"rgb(59, 130, 246)",borderWidth:1}]}:null,Y={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{labels:{color:"#374151",font:{size:12}}}},scales:{x:{grid:{color:"rgba(0,0,0,0.08)"},ticks:{color:"#374151",font:{size:11},maxRotation:45}},y:{beginAtZero:!0,grid:{color:"rgba(0,0,0,0.08)"},ticks:{color:"#374151",font:{size:11}}}}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(A,{children:[e.jsx(q,{children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-5 w-5"}),"Chat"]}),e.jsx(ie,{children:"Ask about members, claims, plans, providers, and more."})]}),e.jsxs("div",{className:"flex gap-2 shrink-0",children:[e.jsxs(y,{variant:"outline",size:"sm",type:"button","aria-expanded":H,"aria-controls":"chat-history-panel",id:"chat-history-button",onClick:()=>k(!0),children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),"History"]}),H&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[200] bg-black/50","aria-hidden":!0,onClick:()=>k(!1)}),e.jsxs("div",{id:"chat-history-panel",className:"fixed inset-y-0 right-0 z-[201] w-full sm:max-w-md flex flex-col bg-background border-l shadow-xl",role:"dialog","aria-label":"Chat history",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{className:"h-4 w-4"}),e.jsx("h2",{className:"font-semibold text-lg",children:"Chat history"})]}),e.jsx(y,{type:"button",variant:"ghost",size:"icon",className:"h-9 w-9","aria-label":"Close",onClick:()=>k(!1),children:e.jsx(de,{className:"h-5 w-5"})})]}),e.jsx("p",{className:"text-sm text-muted-foreground px-4 pb-2",children:"Click a question to ask it again."}),e.jsx("ul",{className:"flex-1 overflow-y-auto space-y-1 p-4 pt-0",children:x.length===0?e.jsx("li",{className:"text-sm text-muted-foreground py-4",children:"No questions yet."}):x.map(({index:s,text:o})=>e.jsx("li",{children:e.jsxs("button",{type:"button",onClick:()=>X(o),disabled:d.isPending,className:"w-full text-left rounded-lg border bg-muted/30 hover:bg-muted/60 px-3 py-2.5 text-sm transition-colors disabled:opacity-50 flex items-start gap-2",children:[e.jsx(ye,{className:"h-4 w-4 shrink-0 mt-0.5 text-muted-foreground"}),e.jsx("span",{className:"line-clamp-3 break-words",children:o})]})},s))})]})]}),n.length>0&&e.jsxs(y,{variant:"outline",size:"sm",onClick:S,children:[e.jsx(Ne,{className:"h-4 w-4 mr-2"}),"New chat"]})]})]})}),e.jsxs(L,{className:"space-y-4",children:[e.jsxs("div",{className:"max-h-96 overflow-y-auto rounded-md border bg-muted/30 p-4 space-y-3",children:[n.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"e.g. How many active members? Top 10 claims by amount?"}),n.map((s,o)=>e.jsx("div",{className:`flex ${s.role==="user"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[85%] rounded-lg px-4 py-2 text-sm ${s.role==="user"?"bg-primary text-primary-foreground":"bg-muted border"}`,children:[e.jsx("p",{className:"whitespace-pre-wrap",children:s.text}),s.meta&&e.jsx(ce,{variant:"secondary",className:"mt-2 text-xs",children:s.meta})]})},o)),d.isPending&&e.jsx("div",{className:"flex justify-start",children:e.jsxs("div",{className:"rounded-lg border bg-muted px-4 py-2",children:[e.jsx(P,{className:"h-4 w-48"}),e.jsx(P,{className:"h-4 w-32 mt-2"})]})}),e.jsx("div",{ref:p})]}),e.jsxs("form",{onSubmit:w,className:"flex gap-2",children:[e.jsx(ue,{placeholder:"Ask a question...",value:t,onChange:s=>a(s.target.value),disabled:d.isPending,className:"flex-1"}),e.jsx(y,{type:"submit",disabled:d.isPending,children:d.isPending?"Askingâ€¦":"Ask"})]})]})]}),l&&e.jsxs(A,{children:[e.jsx(q,{children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsx(O,{children:"Results"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(y,{variant:"outline",size:"sm",onClick:c,disabled:!l.columns?.length||!l.data?.length,children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Download CSV"]}),e.jsxs(y,{variant:"outline",size:"sm",onClick:()=>b(s=>!s),disabled:!l.data?.length,children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),g?"Hide":"Show"," chart"]})]})]})}),e.jsxs(L,{className:"space-y-4",children:[l.sql&&e.jsx("pre",{className:"rounded-md border bg-muted/50 p-4 text-xs overflow-x-auto",children:l.sql}),e.jsx("div",{className:"rounded-md border",children:l.columns?.length&&l.data?.length?e.jsxs(D,{children:[e.jsx(U,{children:e.jsx(T,{children:l.columns.map(s=>e.jsx(J,{children:s},s))})}),e.jsx(G,{children:l.data.map((s,o)=>e.jsx(T,{children:s.map((j,_)=>e.jsx(K,{children:j!=null?String(j):""},_))},o))})]}):e.jsx("p",{className:"p-4 text-muted-foreground text-sm",children:"No rows returned."})}),g&&z&&e.jsx("div",{className:"h-80 rounded-lg bg-white p-4 shadow-sm border border-border/50",children:e.jsx(_e,{data:z,options:Y})})]})]})]})}export{qe as component};
